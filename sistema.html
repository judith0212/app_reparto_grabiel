<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Reparto - Sistema</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.png" type="image/png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Mi App">
    <!-- Carga de Tailwind CSS para un dise√±o limpio y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #f3f8ff, #d6e4f0);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Modal de confirmaci√≥n personalizado -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1001]">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmar acci√≥n</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-24 mr-2 shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Aceptar
                    </button>
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-24 shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n de cerrar sesi√≥n en la esquina superior derecha -->
    <button onclick="logout()" class="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-red-700 transition duration-200">
        Cerrar Sesi√≥n
    </button>

    <div class="flex flex-col items-center mb-6">
        <img id="fotoPerfil" class="w-20 h-20 rounded-full object-cover border-2 border-blue-500" src="" alt="Foto de perfil">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mt-2 text-center">Bienvenido, a tu APP de REPARTO <span id="nombreUsuario"></span></h2>
    </div>

    <div class="flex flex-wrap justify-between gap-4 mb-6">
        <button onclick="verHistorial()" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-blue-600 transition duration-200 min-w-[150px]">
            üìÖ Ver historial
        </button>
        <button onclick="guardarDatos()" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-blue-600 transition duration-200 min-w-[150px]">
            üíæ Guardar ahora
        </button>
    </div>

    <div id="tablasContainer" class="space-y-8">
    </div>

    <div id="fechaList" class="hidden mt-6 max-w-sm mx-auto"></div>

    <div id="historialFecha" class="hidden p-4 bg-white rounded-lg shadow-md mt-6"></div>

    <button id="volverBtn" onclick="volverAEdicion()" class="hidden mt-4 mx-auto block bg-gray-500 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-gray-600 transition duration-200">
        üîô Volver a edici√≥n
    </button>

    <script>
        // ‚úÖ PWA: Registro del Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado con √©xito: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('Fallo al registrar ServiceWorker: ', err);
                    });
            });
        }

        // ===== TU C√ìDIGO ORIGINAL MODIFICADO AQU√ç =====
        const usuario = localStorage.getItem("user");
        if (!usuario) window.location.href = "login.html";
        document.getElementById("nombreUsuario").textContent = usuario;

        // Asigna la foto seg√∫n el usuario
        const fotosUsuarios = {
            "Jheydyramos": "foto1.jpg",
            "Grabielolivazapata": "grabiel.jpg",
            "cliente3": "goku.jpg"
        };

        if (fotosUsuarios[usuario]) {
            document.getElementById("fotoPerfil").src = fotosUsuarios[usuario];
        } else {
            document.getElementById("fotoPerfil").src = "default.jpg";
        }

        const tablaCount = 3;
        const filasPorTabla = 60;
        const metodos = ["Seleccione", "Efectivo", "Yape", "Transferencia", "Mixto", "No pago"];
        const estados = ["Entregado", "No entregado", "Rechazado"];
        const preventas = ["Seleccione", "Victor", "Milka", "Sandra", "Lia", "Alvaro"];
        const fechaActual = new Date().toLocaleDateString('es-PE');
        let activeInput = null; // Variable para rastrear el input activo del teclado virtual

        function claveDatos(fecha) {
            return `datos_${usuario}_${fecha}`;
        }

        const datosGuardados = JSON.parse(localStorage.getItem(claveDatos(fechaActual))) || {};
        const container = document.getElementById("tablasContainer");

        for (let t = 1; t <= tablaCount; t++) {
            const tabla = document.createElement("table");
            tabla.id = "tabla" + t;
            tabla.className = "w-full border-collapse bg-white rounded-lg shadow-md mb-8";
            const thead = tabla.createTHead();
            thead.className = "bg-blue-600 text-white";
            thead.innerHTML = `
                <tr>
                    <th class="p-2 border border-gray-300 rounded-tl-lg">#</th>
                    <th class="p-2 border border-gray-300">Monto</th>
                    <th class="p-2 border border-gray-300">Estado</th>
                    <th class="p-2 border border-gray-300">M√©todo</th>
                    <th class="p-2 border border-gray-300">Preventa</th>
                    <th class="p-2 border border-gray-300">Efectivo</th>
                    <th class="p-2 border border-gray-300">Yape</th>
                    <th class="p-2 border border-gray-300 rounded-tr-lg">Faltante</th>
                </tr>
            `;
            const tbody = tabla.createTBody();

            for (let i = 0; i < filasPorTabla; i++) {
                const fila = tbody.insertRow();
                const datos = datosGuardados["tabla" + t]?.[i] || {};
                fila.className = "border-b border-gray-200";
                fila.innerHTML = `
                    <td class="p-2 text-center">${i + 1}</td>
                    <!-- ‚úÖ CAMBIO: inputmode="decimal" para que aparezca el teclado nativo con punto decimal -->
                    <td class="p-2"><input type="text" class="monto w-full p-1 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value="${datos.monto || ""}" inputmode="decimal"></td>
                    <td class="p-2"><select class="estado w-full p-1 rounded-md border border-gray-300">${estados.map(e => `<option ${e === datos.estado ? "selected" : ""}>${e}</option>`)}</select></td>
                    <td class="p-2"><select class="metodo w-full p-1 rounded-md border border-gray-300">${metodos.map(m => `<option ${m === datos.metodo ? "selected" : ""}>${m}</option>`)}</select></td>
                    <td class="p-2"><select class="preventa w-full p-1 rounded-md border border-gray-300">${preventas.map(p => `<option ${p === datos.preventa ? "selected" : ""}>${p}</option>`)}</select></td>
                    <td class="p-2"><input type="number" class="efectivo w-full p-1 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" value="${datos.efectivo || ""}"></td>
                    <td class="p-2"><input type="number" class="yape w-full p-1 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" value="${datos.yape || ""}"></td>
                    <td class="faltante p-2 text-center text-sm"></td>
                `;
            }

            const tfoot = tabla.createTFoot();
            tfoot.innerHTML = `
                <tr class="font-bold bg-gray-100">
                    <td colspan="2" class="p-2 text-right">Total General:</td>
                    <td colspan="2" class="totalGeneral p-2 text-center">S/ 0.00</td>
                    <td class="p-2">Yape:</td>
                    <td class="totalYape p-2 text-center">S/ 0.00</td>
                    <td class="p-2">Efectivo:</td>
                    <td class="p-2 text-center">S/ 0.00</td>
                </tr>
                <tr class="font-bold bg-gray-100">
                    <td colspan="2" class="p-2 text-right">Total Transferencia:</td>
                    <td colspan="6" class="totalTransferencia p-2 text-center">S/ 0.00</td>
                </tr>
            `;

            container.appendChild(document.createElement("h3")).textContent = "Preventa " + t;
            container.appendChild(tabla);
            const deudaDiv = document.createElement("div");
            deudaDiv.id = "deuda" + t;
            deudaDiv.className = "deudaPreventa bg-yellow-100 p-3 rounded-lg font-bold mb-8";
            container.appendChild(deudaDiv);
        }

        // Funci√≥n segura para evaluar operaciones como 4+57+4 en todos los dispositivos
        function evalSafe(expr) {
            try {
                expr = String(expr).replace(/[^0-9+\-*/.]/g, ""); // Solo n√∫meros y operadores
                if (!expr.trim()) return 0;
                return new Function("return " + expr)();
            } catch {
                return 0;
            }
        }

        function calcularTotales() {
            for (let t = 1; t <= tablaCount; t++) {
                const tabla = document.getElementById("tabla" + t);
                let total = 0, totalYape = 0, totalEfectivo = 0, totalTransferencia = 0;
                let deudas = {};

                [...tabla.tBodies[0].rows].forEach(fila => {
                    const montoInput = fila.querySelector(".monto");
                    const estado = fila.querySelector(".estado").value;
                    const metodo = fila.querySelector(".metodo").value;
                    const preventa = fila.querySelector(".preventa").value;
                    const efectivoInput = fila.querySelector(".efectivo");
                    const yapeInput = fila.querySelector(".yape");
                    const faltanteCelda = fila.querySelector(".faltante");

                    let monto = 0;
                    if (montoInput) {
                        monto = evalSafe(montoInput.value);
                    }

                    let efectivo = parseFloat(efectivoInput.value) || 0;
                    let yape = parseFloat(yapeInput.value) || 0;
                    let suma = efectivo + yape;

                    // Bloqueo de campos seg√∫n m√©todo
                    efectivoInput.disabled = metodo === "Yape" || metodo === "Transferencia" || metodo === "No pago";
                    yapeInput.disabled = metodo === "Efectivo" || metodo === "Transferencia" || metodo === "No pago";

                    // Si no entregado o rechazado, limpiar
                    if (estado === "No entregado" || estado === "Rechazado" || monto === 0) {
                        fila.classList.remove("error");
                        faltanteCelda.textContent = "";
                        if (estado !== "Entregado") {
                            efectivoInput.value = "";
                            yapeInput.value = "";
                        }
                        return;
                    }

                    if (metodo === "No pago") {
                        total += monto;
                        if (preventa !== "Seleccione") {
                            deudas[preventa] = (deudas[preventa] || 0) + monto;
                            faltanteCelda.textContent = "Deuda: S/ " + monto.toFixed(2);
                            faltanteCelda.style.color = "red";
                        } else {
                            faltanteCelda.textContent = "";
                        }
                        efectivoInput.value = "";
                        yapeInput.value = "";
                        fila.classList.remove("error");
                        return;
                    }

                    if (metodo === "Transferencia") {
                        total += monto;
                        totalTransferencia += monto;
                        efectivoInput.value = "";
                        yapeInput.value = "";
                        faltanteCelda.textContent = "";
                        fila.classList.remove("error");
                        return;
                    }
                    
                    // Si el m√©todo est√° en "Seleccione" pero el pedido fue entregado, sumarlo igual
                    if (metodo === "Seleccione" && estado === "Entregado") {
                        total += monto;
                        return; // no tocar efectivo/yape
                    }

                    if (metodo === "Mixto") {
                        total += monto;
                        totalEfectivo += efectivo;
                        totalYape += yape;
                    }

                    if (["Efectivo", "Yape"].includes(metodo)) {
                        // ‚úÖ CORRECCI√ìN: Autocompletar solo si el monto es un n√∫mero sin operadores
                        if (!String(montoInput.value).includes("+") && !String(montoInput.value).includes("-") && !String(montoInput.value).includes("*") && !String(montoInput.value).includes("/")) {
                            if (metodo === "Efectivo") {
                                efectivoInput.value = monto.toFixed(2);
                                yapeInput.value = "";
                                yape = 0;
                                efectivo = monto;
                            } else if (metodo === "Yape") {
                                yapeInput.value = monto.toFixed(2);
                                efectivoInput.value = "";
                                efectivo = 0;
                                yape = monto;
                            }
                        }
                        total += monto;
                        totalEfectivo += efectivo;
                        totalYape += yape;
                    }

                    // Mostrar faltante o sobrante
                    const diferencia = monto - suma;
                    if (Math.abs(diferencia) > 0.01) {
                        fila.classList.add("error");
                        if (diferencia > 0) {
                            faltanteCelda.textContent = "Falta: S/ " + diferencia.toFixed(2);
                            faltanteCelda.style.color = "red";
                        } else {
                            faltanteCelda.textContent = "Sobra: S/ " + Math.abs(diferencia).toFixed(2);
                            faltanteCelda.style.color = "blue";
                        }
                    } else {
                        fila.classList.remove("error");
                        faltanteCelda.textContent = "";
                    }
                });

                tabla.querySelector(".totalGeneral").textContent = "S/ " + total.toFixed(2);
                tabla.querySelector(".totalYape").textContent = "S/ " + totalYape.toFixed(2);
                tabla.querySelector(".totalEfectivo").textContent = "S/ " + totalEfectivo.toFixed(2);
                tabla.querySelector(".totalTransferencia").textContent = "S/ " + totalTransferencia.toFixed(2);

                const deudaDiv = document.getElementById("deuda" + t);
                deudaDiv.innerHTML = "<strong>Estado de preventas:</strong><br>";
                if (Object.keys(deudas).length === 0) {
                    deudaDiv.innerHTML += "Sin deudas por ahora.";
                } else {
                    for (const key in deudas) {
                        deudaDiv.innerHTML += `üü° Preventa ${key} debe: <span style="color:red">S/ ${deudas[key].toFixed(2)}</span><br>`;
                    }
                }
            }
        }

        // ‚úÖ Recalcular siempre que el usuario escriba o cambie algo
        document.addEventListener("input", function(e) {
            if (e.target.classList.contains("monto") ||
                e.target.classList.contains("metodo") ||
                e.target.classList.contains("efectivo") ||
                e.target.classList.contains("yape") ||
                e.target.classList.contains("estado")) {
                
                // Si es un monto, evaluar en vivo
                if (e.target.classList.contains("monto")) {
                    e.target.value = e.target.value.replace(/[^0-9+\-*/.]/g, ""); // Solo n√∫meros y operadores
                }
                calcularTotales();
            }
        });


        function guardarLocal() {
            const datos = {};
            for (let t = 1; t <= tablaCount; t++) {
                const tabla = document.getElementById("tabla" + t);
                datos["tabla" + t] = [...tabla.tBodies[0].rows].map(fila => ({
                    monto: fila.querySelector(".monto").value,
                    estado: fila.querySelector(".estado").value,
                    metodo: fila.querySelector(".metodo").value,
                    preventa: fila.querySelector(".preventa").value,
                    efectivo: fila.querySelector(".efectivo").value,
                    yape: fila.querySelector(".yape").value
                }));
            }
            localStorage.setItem(claveDatos(fechaActual), JSON.stringify(datos));
        }

        function showCustomModal(message, onConfirm) {
            const modal = document.getElementById('custom-modal');
            const msgEl = document.getElementById('modal-message');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            
            msgEl.textContent = message;
            modal.classList.remove('hidden');

            const handleOk = () => {
                onConfirm();
                modal.classList.add('hidden');
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                modal.classList.add('hidden');
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            okBtn.addEventListener('click', handleOk);
            cancelBtn.addEventListener('click', handleCancel);
        }

        function verHistorial() {
            document.getElementById("fechaList").classList.remove("hidden");
            document.getElementById("historialFecha").classList.add("hidden");
            document.getElementById("tablasContainer").classList.add("hidden");
            document.getElementById("volverBtn").classList.remove("hidden");

            const contenedorFechas = document.getElementById("fechaList");
            contenedorFechas.innerHTML = "<h3 class='text-xl font-bold mb-4'>üìÖ Selecciona una fecha:</h3>";

            const fechas = Object.keys(localStorage)
                .filter(k => k.startsWith(`datos_${usuario}_`))
                .sort()
                .reverse();

            fechas.forEach(key => {
                const fecha = key.replace(`datos_${usuario}_`, "");

                const fila = document.createElement("div");
                fila.className = "flex justify-between items-center my-2";

                const btnFecha = document.createElement("button");
                btnFecha.textContent = fecha;
                btnFecha.className = "flex-1 mr-2 p-3 bg-blue-500 text-white rounded-md text-lg shadow-md hover:bg-blue-600 transition duration-200";
                btnFecha.onclick = () => mostrarHistorialDeFecha(fecha);

                const btnEliminar = document.createElement("button");
                btnEliminar.textContent = "üóë";
                btnEliminar.className = "bg-red-500 text-white p-3 rounded-md text-lg shadow-md hover:bg-red-600 transition duration-200";
                btnEliminar.onclick = () => showCustomModal(`¬øSeguro que quieres eliminar el historial del ${fecha}?`, () => eliminarFechaHistorial(fecha));

                fila.appendChild(btnFecha);
                fila.appendChild(btnEliminar);
                contenedorFechas.appendChild(fila);
            });
        }

        function eliminarFechaHistorial(fecha) {
            localStorage.removeItem(`datos_${usuario}_${fecha}`);
            verHistorial();
        }

        function mostrarHistorialDeFecha(fecha) {
            const key = claveDatos(fecha);
            const datos = JSON.parse(localStorage.getItem(key));
            const contenedor = document.getElementById("historialFecha");
            contenedor.classList.remove("hidden");
            contenedor.innerHTML = `<h3 class="text-2xl font-bold mb-4">üóì Historial del ${fecha}</h3>`;

            for (let t = 1; t <= 3; t++) {
                const tablaDatos = datos["tabla" + t];
                if (!tablaDatos) continue;

                const titulo = document.createElement("h4");
                titulo.className = "text-xl font-semibold mt-6 mb-2";
                titulo.textContent = "üßæ Preventa " + t;
                contenedor.appendChild(titulo);

                const tabla = document.createElement("table");
                tabla.className = "w-full border-collapse bg-white rounded-lg shadow-md mb-8";
                tabla.innerHTML = `
                    <thead>
                        <tr class="bg-blue-600 text-white">
                            <th class="p-2 border border-gray-300">#</th><th class="p-2 border border-gray-300">Monto</th><th class="p-2 border border-gray-300">Estado</th><th class="p-2 border border-gray-300">M√©todo</th><th class="p-2 border border-gray-300">Preventa</th><th class="p-2 border border-gray-300">Efectivo</th><th class="p-2 border border-gray-300">Yape</th><th class="p-2 border border-gray-300">Faltante</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;

                const tbody = tabla.querySelector("tbody");
                let total = 0, efectivo = 0, yape = 0, transferencia = 0;
                let deudas = {};

                tablaDatos.forEach((fila, i) => {
                    const monto = evalSafe(fila.monto) || 0; // Utilizar evalSafe para el monto
                    const efec = parseFloat(fila.efectivo) || 0;
                    const yp = parseFloat(fila.yape) || 0;
                    const metodo = fila.metodo;
                    const estado = fila.estado;
                    const preventa = fila.preventa;

                    let faltante = "";
                    let rowClass = "";
                    if (metodo === "No pago" && preventa !== "Seleccione") {
                        deudas[preventa] = (deudas[preventa] || 0) + monto;
                        faltante = `Deuda: S/ ${monto.toFixed(2)}`;
                        rowClass = "bg-red-100 text-red-600";
                    } else if (estado === "Entregado") {
                        const suma = efec + yp;
                        const dif = (monto - suma);
                        if (Math.abs(dif) > 0.01) {
                            faltante = dif > 0 ? `Falta: S/ ${dif.toFixed(2)}` : `Sobra: S/ ${Math.abs(dif).toFixed(2)}`;
                            rowClass = dif > 0 ? "bg-red-100 text-red-600" : "bg-blue-100 text-blue-600";
                        }
                    }
                    if (estado === "Entregado" && !isNaN(monto) && monto > 0) {
                        total += monto;
                        efectivo += efec;
                        yape += yp;
                        if (metodo === "Transferencia") transferencia += monto;
                    }

                    const tr = document.createElement("tr");
                    tr.className = `border-b border-gray-200 ${rowClass}`;
                    tr.innerHTML = `
                        <td class="p-2 text-center">${i + 1}</td>
                        <td class="p-2 text-center">${fila.monto}</td>
                        <td class="p-2 text-center">${fila.estado}</td>
                        <td class="p-2 text-center">${fila.metodo}</td>
                        <td class="p-2 text-center">${fila.preventa}</td>
                        <td class="p-2 text-center">${fila.efectivo}</td>
                        <td class="p-2 text-center">${fila.yape}</td>
                        <td class="p-2 text-center">${faltante}</td>
                    `;
                    tbody.appendChild(tr);
                });

                const tfoot = document.createElement("tfoot");
                tfoot.innerHTML = `
                    <tr class="font-bold bg-gray-100">
                        <td colspan="2" class="p-2 text-right">Total General:</td>
                        <td colspan="2" class="p-2 text-center">S/ ${total.toFixed(2)}</td>
                        <td class="p-2">Yape:</td>
                        <td class="p-2 text-center">S/ ${yape.toFixed(2)}</td>
                        <td class="p-2">Efectivo:</td>
                        <td class="p-2 text-center">S/ ${efectivo.toFixed(2)}</td>
                    </tr>
                    <tr class="font-bold bg-gray-100">
                        <td colspan="2" class="p-2 text-right">Transferencias:</td>
                        <td colspan="6" class="p-2 text-center">S/ ${transferencia.toFixed(2)}</td>
                    </tr>
                `;
                tabla.appendChild(tfoot);
                contenedor.appendChild(tabla);

                const deudaDiv = document.createElement("div");
                deudaDiv.className = "bg-yellow-100 p-3 rounded-lg font-bold mt-4";
                deudaDiv.innerHTML = "<strong>Estado de preventas:</strong><br>";
                if (Object.keys(deudas).length === 0) {
                    deudaDiv.innerHTML += "Sin deudas.";
                } else {
                    for (const k in deudas) {
                        deudaDiv.innerHTML += `üü° Preventa ${k} debe: <span class="text-red-600">S/ ${deudas[k].toFixed(2)}</span><br>`;
                    }
                }
                contenedor.appendChild(deudaDiv);
            }
            document.getElementById("fechaList").classList.add("hidden");
        }

        function volverAEdicion() {
            document.getElementById("fechaList").classList.add("hidden");
            document.getElementById("historialFecha").classList.add("hidden");
            document.getElementById("tablasContainer").classList.remove("hidden");
            document.getElementById("volverBtn").classList.add("hidden");
        }

        function logout() {
            localStorage.removeItem("user");
            window.location.href = "login.html";
        }

        function guardarDatos() {
            guardarLocal();
            console.log("Datos guardados manualmente.");
        }

        // Llamada inicial para cargar los totales y el estado de los inputs
        document.addEventListener("DOMContentLoaded", () => {
            calcularTotales();
        });

        // El guardado autom√°tico se mantiene
        setInterval(() => {
            guardarLocal();
        }, 1000);
    </script>
</body>
</html>
